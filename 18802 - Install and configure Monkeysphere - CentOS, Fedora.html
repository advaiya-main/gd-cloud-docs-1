<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:mso="urn:schemas-microsoft-com:office:office" xmlns:msdt="uuid:C2F41010-65B3-11d1-A29F-00AA00C14882">

<head>

<!--Article Number is __________ (fill in blank)-->

<!--Use this template for articles that explain or describe something (such as an operating system). For articles that include steps for accomplishing a task (for example, installing), use the Informational template instead.  -->


<title>Install and configure Monkeysphere - CentOS, Fedora</title>
<style type="text/css">
div.hacker {
background-color:#666;
border:1px solid #ccc;
color:#fff;
font-family:"Lucida Console","Courier New",Courier,fixed;  font-size:95%;  line-height:160%;  margin-bottom:1.5em;  padding:10px; }

p.note {
 background-color:#ffffe6;
 border:1px solid #eee;
 color:#666;
 padding:.8em 1.6em;
 margin:15px 0;
}

.warning {
 border: 1px #d25100 solid;
 padding: .5em 1em .5em 4em;
 margin: 10px 20px 15px 20px;
 background-image: url('@{help-img-path}/img_warning.gif');
 background-repeat: no-repeat;
 background-position: left top;
 background-color: #ededed;-moz-border-radius:
0.8em;-webkit-border-radius: 0.8em;
 /* -moz-border-bottom-radius: 0;9 */
 -webkit-border-bottom-radius: 0;
 padding-top:14px;
 padding-bottom:15px;
}
</style>


<!--[if gte mso 9]><xml>
<mso:CustomDocumentProperties>
<mso:ArticleKeywords msdt:dt="string">Security, SSH</mso:ArticleKeywords>
<mso:Reference msdt:dt="string">https://www.digitalocean.com/community/tutorials/how-to-validate-ssh-server-identities-with-monkeysphere-on-an-ubuntu-vps, https://www.digitalocean.com/community/tutorials/how-to-validate-ssh-server-identities-with-monkeysphere-on-an-ubuntu-vps</mso:Reference>
<mso:LinuxDistributions msdt:dt="string">;#CentOS;#Fedora;#</mso:LinuxDistributions>
<mso:ArticlePriority msdt:dt="string">8</mso:ArticlePriority>
<mso:RequestNotes msdt:dt="string"></mso:RequestNotes>
<mso:Difficulty msdt:dt="string">2</mso:Difficulty>
<mso:ForkSplit msdt:dt="string"></mso:ForkSplit>
<mso:ArticleID msdt:dt="string">18802</mso:ArticleID>
<mso:UnsupportedFeatures msdt:dt="string"></mso:UnsupportedFeatures>
<mso:Collapsed msdt:dt="string"></mso:Collapsed>
<mso:Complexity msdt:dt="string"></mso:Complexity>
<mso:ArticleStatus msdt:dt="string">Not started</mso:ArticleStatus>


<mso:Sample msdt:dt="string">z</mso:Sample>
<mso:DeliveryTarget msdt:dt="string"></mso:DeliveryTarget>
<mso:EditScore msdt:dt="string"></mso:EditScore>
<mso:PrereqOrdering msdt:dt="string">2</mso:PrereqOrdering>
<mso:AssignedTo1 msdt:dt="string">12</mso:AssignedTo1>
<mso:display_urn_x003a_schemas-microsoft-com_x003a_office_x003a_office_x0023_AssignedTo1 msdt:dt="string">Tom Taylor</mso:display_urn_x003a_schemas-microsoft-com_x003a_office_x003a_office_x0023_AssignedTo1>
</mso:CustomDocumentProperties>
</xml><![endif]-->
</head>

<body>

    <h1>Install and configure Monkeysphere - CentOS, Fedora</h1>
    
    <p><strong>Difficulty</strong>: <em>2</em><br/>
        <strong>Time</strong>: <em>3 hours</em></p>

    <p>In this article, you will learn how to install and configure Monkeysphere, which will allow you to have a trusted SSH login.</p>

    <p>You should have 3 droplets for configuring and testing purpose.</p>
    <ul>
	<li>server.example.com: The SSH server to which you connect.</li>
	<li>admin.example.com: Administrator computer that is used to configure access.</li>
	<li>client.example.com: The client from which you initiate the connection.</li>
	<li>The SSH server should have domain name which is publically accessible.</li>
   </ul>
     <p>Instead of server key, use GPG's web of trust model. </p>
	 
	 <h2>Build GPG keys and authentication</h2>
	 <p>Configure GPG Keys on client and admin droplets. This process include below steps:</p>
<ol> 
<li>Generate GPG Keys.
<p>This should be performed in both client and admin droplets.</p>
   <div class="hacker">gpg --gen-key</div>
   <p>This will begin the process of GPG key generation where a series of questions will be asked.</p>
   <p>Choose 1 to create two RSA keys. Choose 2048 bit encryption for key length. Select ‘O’ so that key won’t expire and finally press ‘Y’ to confirm the details provided.</p>
   <p>Provide user as client in client droplet and admin in admin droplet. Give an email address as <em><u>client@junkdomain.com</u></em> or <em><u>admin@junkdomain.com </u></em>accordingly.</p>
   <p>It will take some time to complete the key generation process. </p>
   <p>View the key using following command:</p>
   <div class="hacker">
<pre>
gpg --list-keys
/home/user/.gnupg/pubring.gpg
----------------------------
pub   2048R/1258D8EF 2015-09-06
uid                  client &lt;client@junkdomain.com&gt;
sub   2048R/FF569918 2015-09-06
</pre>
   </div>
   <p>Issue above command in admin droplet and you will see the keys in both droplets.</p>
   </li>
   <li>Upload keys to key-server.
   <p>You can find the key id from above command. In this case Key id is 1258D8EF. Perform this step on both client and admin droplets.</p>
   <div class="hacker">gpg --send-key <em><u>1258D8EF</u></em></div>
   </li>
   <li>Signing the Keys.
   <p>Pull down the opposite key on each of droplets/servers and then sign those keys.</p>
   <p>Get the figure print In Client droplet.</p>
   <div class="hacker">gpg --with-colons --fingerprint client</div>
   <div class="hacker">
<pre>
tru::1:1441518267:0:3:1:5
pub:u:2048:1:9E0613031258D8EF:2015-09-06:::u:client &lt;client@junkdomain.com&gt;::scESC:
fpr:::::::::BF867BD82FAF8559633336829E0613031258D8EF:
sub:u:2048:1:E0150AD6FF569918:2015-09-06::::::e: 
</pre>
   </div>
   <p>The portion of the output that is highlighted is the fingerprint for client.</p>
   <p>On admin droplet, download the key, sign and then upload it to key-server.</p>
   <div class="hacker">
<pre>
gpg --recv-keys BF867BD82FAF8559633336829E0613031258D8EF
gpg --sign-key BF867BD82FAF8559633336829E0613031258D8EF
gpg --send-key BF867BD82FAF8559633336829E0613031258D8EF
</pre>
   </div>
   <p>Do the opposite on admin droplet. Take the fingerprint of admin key and then download, sign and upload the key from client droplet.</p>
   <p>Take the fingerprint from admin droplet.</p>
   <div class="hacker">gpg --with-colons --fingerprint admin</div>
   <p>On Client droplet, download the key, sign and then upload it to key-server.</p>
   <div class="hacker">
<pre>
gpg --recv-keys BF867BD82FAF8559633336829E0613031258D8EF
gpg --sign-key BF867BD82FAF8559633336829E0613031258D8EF
gpg --send-key BF867BD82FAF8559633336829E0613031258D8EF
</pre>
   </div>
   <p>Refresh both your server keys now. You will get the proper result when the propagation completes.  Wait for few minutes and then execute below command:</p>
   <div class="hacker">gpg --refresh-keys</div>
   <p>You will see an output stating “new signatures: 1”. When this is shown, you have done it properly. Otherwise wait for some more time and issue the refresh command.</p>
   </li>
   <li>Trust the Administrator's Judgment
   <p>Through this, client will know that the SSH server which it is connecting is trusted by administrator.</p>
   <p>Check the current trust settings of client.</p>
   <div class="hacker">gpg --check-trustdb</div>
   <p>Update the trust by  executing the below command.</p>
   <div class="hacker">gpg --update-trustdb</div>
   <p>Choose option 4 to trust fully. On successful execution, you will get the below output.</p>
   <div class="hacker">
<pre>
gpg: 3 marginal(s) needed, 1 complete(s) needed, PGP trust model
gpg: depth: 0  valid:   1  signed:   1  trust: 0-, 0q, 0n, 0m, 0f, 1u
gpg: depth: 1  valid:   1  signed:   0  trust: 0-, 0q, 0n, 0m, 0f, 0u
</pre>
   </div>
   <p>The value 0 -, shows that both keys are trusted.</p>
   </li>
  </ol>

<h2>Install Monkeysphere </h2>
<p>Perform below step on all droplets (Client, Admin and on SSH Server).</p>
<p>In CentOS droplets, you need to first install dependencies and then install Monkeysphere through rpm package. While in Fedora, you can install it directly through yum package manager.</p>
<ol>
<li>Install Dependencies.
   <div class="hacker">sudo yum install epel-release</div>
   <div class="hacker">sudo yum install fedora-usermgmt perl-Crypt* perl-Digest* socat</div>
   </li>
 
  <li>Install Monkeysphere.
   <div class="hacker">wget http://rpm.razorsedge.org/centos-6/RE/monkeysphere-0.35-1.el6.re.noarch.rpm</div>
   </li>
  <li>In Fedora droplet, install Monkeysphere as:
   <div class="hacker">sudo yum install monkeysphere</div>
   </li>

   <li>On SSH Server, generate GPG key.
   <div class="hacker">sudo monkeysphere-host import-key /etc/ssh/ssh_host_rsa_key ssh:// <em><u>server.example.com</u></em></div>
   </li>
   
   <li>Upload the key to key-server.
   <div class="hacker">sudo monkeysphere-host publish-key</div>
   </li>
  </ol>

<h2>Validate server key as server administrator</h2>
<ol>
<li>Sign SSH server's GPG key as server administrator, so that client user verify server identify by trusting administrator.
<p>Get the GPG fingerprint on SSH server.</p>
   <div class="hacker">sudo monkeysphere-host show-key</div>
   <div class="hacker">
<pre>
pub   2048R/3F68800A 2015-09-06
uid                  ssh://server.example.com
OpenPGP fingerprint: <em><u>58921230505B96E5D50A8968684414D33F68800A</u></em>
ssh fingerprint: 2048 35:77:0b:f6:9b:1e:7c:69:45:6a:20:54:ab:ef:84:33 (RSA)
</pre>
   </div>
   </li>
   <li>On admin droplet, execute below command to receive, sign and upload key to key-server.
   <div class="hacker">
<pre>
gpg --recv-key  58921230505B96E5D50A8968684414D33F68800A
gpg --sign-key 58921230505B96E5D50A8968684414D33F68800A
gpg --send-key 58921230505B96E5D50A8968684414D33F68800A
</pre>
   </div> 
  </li>
   </ol>
  


<h2>Verifying Identity/Key of SSH server from client</h2>
<ol>
<li>Execute below command to verify the identity.
   <div class="hacker">ssh -oProxyCommand='monkeysphere ssh-proxycommand %h %p' <em><u>server.example.com</u></em></div>
   </li>
  <li>This command will give below output.
   <div class="hacker">
<pre>
-------------------- Monkeysphere warning -------------------
Monkeysphere found OpenPGP keys for this hostname, but none had full validity.
An OpenPGP key matching the ssh key offered by the host was found.
pub   2048R/3F68800A 2015-09-06
uid       [ unknown] ssh://server.example.com
sig!3        3F68800A 2015-09-06  ssh://server.example.com
RSA key fingerprint is 35:77:0b:f6:9b:1e:7c:69:45:6a:20:54:ab:ef:84:33.
-------------------- ssh continues below --------------------
The authenticity of host 'server.example.com (&lt;no hostip for proxy command&gt;)' can't be established.
ECDSA key fingerprint is d5:46:6c:0f:eb:a9:d1:e1:02:c6:61:d0:37:ea:98:68.
Are you sure you want to continue connecting (yes/no)? 
</pre>
   </div></li>
   
   <li>You are prompted for a verification step. At this stage, you are not sure that you are connecting to the right server. So here you can give no and discontinue the process.
   <p>You can see that server key is found in your key list at this point.</p>
   <div class="hacker">gpg --list-keys</div>
   <div class="hacker">
<pre>
/home/nik/.gnupg/pubring.gpg
----------------------------
pub   2048R/1258D8EF 2015-09-06
uid                  client &lt;client@junkdomain.com&gt;
sub   2048R/FF569918 2015-09-06
pub   2048R/462908AF 2015-09-05
uid                  admin &lt;admin@junkdomain.com&gt;
sub   2048R/62F4D3E5 2015-09-05
pub   2048R/3F68800A 2015-09-06
uid                  ssh://server.example.com
</pre>
   </div>
   </li>
   
  <li>Wait for some time, and issue below command on all droplets to refresh the keys:
   <div class="hacker">gpg --refresh-keys</div>
   </li>
   <li>In the output, you will see “new signatures: 1”. Now everything is proper. At this time, if you check the signature of the server from client, you can find both admin and server keys.
   <div class="hacker">gpg --list-sigs ssh://server.example.com</div>
   <div class="hacker">
<pre>
pub   2048R/3F68800A 2015-09-06
uid                  ssh://server.example.com
sig 3        3F68800A 2015-09-06  ssh://server.example.com
sig          462908AF 2015-09-06  admin admin@fakedomain.com
</pre>
   </div></li>
   <li>Issue command to connect to server, and at this time you won’t get any warning message.
   <div class="hacker">ssh -oProxyCommand='monkeysphere ssh-proxycommand %h %p' <em><u>server.example.com</u></em></div>
   <div class="hacker">user@server.example.com's password:</div>
   </li>
   </ol>
   
   <h2>Make client-server connection easier</h2>
   <ol>
<li>Make the connecting procedure easier by adding the command in client’s ssh configuration file.
   <div class="hacker">sudo vi ~/.ssh/config</div>
   <div class="hacker">Host *</div>
 <div class="hacker">ProxyCommand monkeysphere ssh-proxycommand %h %p  </div>
 <p>This will perform all verification process and you will only get a password prompt.</p>
 </li>
	<li>To test further, you can even clear the ssh known_hosts file and try to ssh, you won’t be asked to accept the hosts.
   <div class="hacker">ssh server.example.com</div>
   <div class="hacker">user@server.example.com's password:</div>
	</li> 
	</ol>
	
    <h2>Conclusion</h2>
    <p>In this article, you have learnt about installing and configuring Monkeysphere in Ubuntu/Debian droplet to trust the ssh server. With this, if the administrator trusts the server, then clients won’t be asked to validate server for connection. </p>
   
</body>
</html>