<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:mso="urn:schemas-microsoft-com:office:office" xmlns:msdt="uuid:C2F41010-65B3-11d1-A29F-00AA00C14882">

<head>

<!--Article Number is __________ (fill in blank)-->

<!--Use this template for articles that explain or describe something (such as an operating system). For articles that include steps for accomplishing a task (for example, installing), use the Informational template instead.  -->


<title>Install and configure Puppet to manage your server - Ubuntu</title>
<style type="text/css">
div.hacker {
background-color:#666;
border:1px solid #ccc;
color:#fff;
font-family:"Lucida Console","Courier New",Courier,fixed;  font-size:95%;  line-height:160%;  margin-bottom:1.5em;  padding:10px; }

p.note {
 background-color:#ffffe6;
 border:1px solid #eee;
 color:#666;
 padding:.8em 1.6em;
 margin:15px 0;
}

.warning {
 border: 1px #d25100 solid;
 padding: .5em 1em .5em 4em;
 margin: 10px 20px 15px 20px;
 background-image: url('@{help-img-path}/img_warning.gif');
 background-repeat: no-repeat;
 background-position: left top;
 background-color: #ededed;-moz-border-radius:
0.8em;-webkit-border-radius: 0.8em;
 /* -moz-border-bottom-radius: 0;9 */
 -webkit-border-bottom-radius: 0;
 padding-top:14px;
 padding-bottom:15px;
}
</style>


<!--[if gte mso 9]><xml>
<mso:CustomDocumentProperties>
<mso:ArticleKeywords msdt:dt="string">Puppet, Automation</mso:ArticleKeywords>
<mso:Reference msdt:dt="string">https://www.digitalocean.com/community/tutorials/how-to-install-puppet-to-manage-your-server-infrastructure, https://www.digitalocean.com/community/tutorials/how-to-install-puppet-to-manage-your-server-infrastructure</mso:Reference>
<mso:LinuxDistributions msdt:dt="string">;#Ubuntu;#</mso:LinuxDistributions>
<mso:ArticlePriority msdt:dt="string">1</mso:ArticlePriority>
<mso:RequestNotes msdt:dt="string">Configure puppet to automate server configuration across multiple machines. Master sheet is ubuntu, but make different install/config instructions for each distro. Will need link to Configure bind as private network dns server, and UFW tutorial.</mso:RequestNotes>
<mso:Difficulty msdt:dt="string">4</mso:Difficulty>
<mso:ForkSplit msdt:dt="string"></mso:ForkSplit>
<mso:ArticleID msdt:dt="string">17388</mso:ArticleID>
<mso:UnsupportedFeatures msdt:dt="string">Private Networking</mso:UnsupportedFeatures>
<mso:Collapsed msdt:dt="string"></mso:Collapsed>
<mso:Complexity msdt:dt="string"></mso:Complexity>

<mso:ArticleStatus msdt:dt="string">Not started</mso:ArticleStatus>

<mso:HoursDraftingEstimated msdt:dt="string">3.50000000000000</mso:HoursDraftingEstimated>
<mso:HoursEditingEstimated msdt:dt="string">0.500000000000000</mso:HoursEditingEstimated>
<mso:Sample msdt:dt="string">z</mso:Sample>
<mso:display_urn_x003a_schemas-microsoft-com_x003a_office_x003a_office_x0023_AssignedTo1 msdt:dt="string">Brian Miller</mso:display_urn_x003a_schemas-microsoft-com_x003a_office_x003a_office_x0023_AssignedTo1>
<mso:DeliveryTarget msdt:dt="string"></mso:DeliveryTarget>
<mso:EditScore msdt:dt="string"></mso:EditScore>
<mso:display_urn_x003a_schemas-microsoft-com_x003a_office_x003a_office_x0023_ReviewedBy msdt:dt="string">Carla  Johnson</mso:display_urn_x003a_schemas-microsoft-com_x003a_office_x003a_office_x0023_ReviewedBy>
<mso:ReviewedBy msdt:dt="string">41</mso:ReviewedBy>
<mso:ReviewComments msdt:dt="string"></mso:ReviewComments>
<mso:UpdateWeeklyHours msdt:dt="string">0</mso:UpdateWeeklyHours>
<mso:Dependencies msdt:dt="string"></mso:Dependencies>
<mso:PrereqOrdering msdt:dt="string">4</mso:PrereqOrdering>
<mso:AssignmentAction msdt:dt="string"></mso:AssignmentAction>
</mso:CustomDocumentProperties>
</xml><![endif]-->
</head>

<body>
<p></p>
    <h1>Install and configure Puppet to manage your server - Ubuntu</h1>
    
    <p><strong>Difficulty</strong>: <em><u>4</u></em><br/>
        <strong>Time</strong>: <em><u>40 minutes</u></em></p>

    <p>Puppet is a configuration management system that helps to automate configuration and management of server infrastructure.</p>
	Puppets are of two types:
	<ul>
		<li>Puppet Enterprise</li>
		<li>Open source Puppet</li>
	</ul>
	<p>
	In this article, you will learn to install open source puppet in a Master-Agent server setup. This includes a Puppet Master server which has all the configuration files and Puppet Agent server which will be querying for Master server for updates.
	</p>
	<p>You must have root access to follow this tutorial. You must have configured a private network DNS. You should check and confirm that port 8140 is accessible. </p>
	<p>Throughout this article, the below naming conventions will be used:</p>
	<ul>
		<li>For puppet master server hostname will be <strong>puppet</strong> and corresponding FQDN will be <strong>puppet.coolexample.com</strong></li>
		<li>For host nodes, it is <strong>host1</strong> and <strong>host2</strong> and its FQDN <strong>host1.coolexample.com </strong>and <strong>host2.coolexample.com</strong>.</li>
	</ul>
	<h2>Install NTP</h2>
	If time is not properly adjusted, it can cause errors when puppet master issues agents certificates.
	<ol>
		<li>
			Synchronize using <code>ntpdate</code> command: 
			<div class="hacker">
				sudo apt-get install ntpdate <br />
				sudo ntpdate pool.ntp.org
			</div>
		</li>
		<li>
			Install NTP daemon so that time will be automatically updated.
			<div class="hacker">
				sudo apt-get update &amp;&amp; sudo apt-get -y install ntp
			</div>
		</li>
		<li>
			Edit ntp.conf file.,
			<div class="hacker">
				sudo vi /etc/ntp.conf
			</div>
		</li>
		<li>
			Add time servers from NTP Pool Project page.:
			<div class="hacker">
				server 0.us.pool.ntp.org<br />
				server 1.us.pool.ntp.org<br />
				server 2.us.pool.ntp.org<br />
				server 3.us.pool.ntp.org

			</div>
		</li>
		<li>
			Save the file and then restart NTP. 
			<div class="hacker">
				ssudo service ntp restart
			</div>
			Server will  have accurate time now.
		</li>
	</ol>
	<h2>Install Puppet Master</h2>
	In this tutorial, you will install Open Source Puppet using from Debian package <strong>puppetmaster-passenger</strong>, this contains puppet master along with production-ready webserver (Apache).
	<ol>
		<li>
			Download package.
			<div class="hacker">
				wget https://apt.puppetlabs.com/puppetlabs-release-trusty.deb
			</div>
		</li>
		<li>
			Install package.
			<div class="hacker">
				sudo dpkg -i puppetlabs-release-trusty.deb
			</div>
		</li>
		<li>
			Update package list.
			<div class="hacker">
				sudo apt-get update
			</div>
		</li>
		<li>
			Install <code>puppetmaster-passenger</code> package.
			<div class="hacker">
				sudo apt-get install puppetmaster-passenger
			</div>
		</li>
		
		<li>
			You  have installed puppetmaster, Apache and all relevant packages to your server. For your information, since you are using Apache, puppet master process will be controlled by Apache processes.  Stop puppet master by stopping Apache service in the server.
			<div class="hacker">
				sudo service apache2 stop
			</div>
		</li>
	</ol>
	<h2>Lock Puppet Version</h2>
	If the built puppet server is updated or changed to another version, then it will stop working. For gaining consistency in this case, you need to maintain a single version in the server. In a puppet infrastructure, if agents have higher version number, then master wonâ€™t be able to manage the same.  For this reason you need to lock the current version.
	<ol>
		<li>View the current version.
			<div class="hacker">
			puppet help | tail -n 1
			</div>
		</li>
		<li>Create following file in apt preference directory.
			<div class="hacker">
			sudo vi /etc/apt/preferences.d/00-puppet.pref
			</div>
		</li>
		<li>Add the below lines:
			<div class="hacker">
			# /etc/apt/preferences.d/00-puppet.pref<br />
			Package: puppet puppet-common puppetmaster-passenger<br />
			Pin: version 3.8*<br />
			Pin-Priority: 501

			</div>
		</li>
		<li>Save the file and exit. Now your puppet version is locked.</li>
	</ol>
	<h2>Names and Certificates </h2>
	Communication between puppet master and agent is being authenticated through SSL Certificates. Follow the below steps to generate master SSL certificate.
	<ol>
		<li>Delete existing certificates from <code>/var/lib/puppet/ssl</code>.
			<div class="hacker">
				sudo rm -rf /var/lib/puppet/ssl
			</div>
		</li>
		<li>Edit <code>/etc/puppet/puppet.conf </code>file, in order to configure certificate.
			<div class="hacker">
				sudo vi /etc/puppet/puppet.conf
			</div>
		</li>
		<li>It will look like:
			<div class="hacker">
			[main]<br />
			logdir=/var/log/puppet<br />
vardir=/var/lib/puppet<br />
ssldir=/var/lib/puppet/ssl<br />
rundir=/var/run/puppet<br />
factpath=$vardir/lib/facter<br />
templatedir=$confdir/templates<br />
<br />
[master]<br />
# These are needed when the puppetmaster is run by passenger<br />
# and can safely be removed if webrick is used.<br />
ssl_client_header = SSL_CLIENT_S_DN<br />
ssl_client_verify_header = SSL_CLIENT_VERIFY<br />

			</div>
		</li>
		<li>Remove <code>templatedir</code> option and then in master section add below:
			<div class="hacker">
			certname = puppet<br />
dns_alt_names = puppet,puppet.coolexample.com

			</div>
		</li>
		<li>Generate new Certificate:
			<div class="hacker">
				sudo puppet master --verbose --no-daemonize
			</div>
			This will generate new certificate for puppet master. After running this command, you will see this line, Notice: Starting Puppet master version 3.8.2. This means that execution is completed. Press Ctrl + c to end the process.
		</li>
	</ol>
<h2>Configure Puppet Master </h2>
<ol>
	<li>Edit configuration file <code>/etc/puppet/puppet.conf</code> for configuring Puppet. 
		<div class="hacker">
		sudo vi /etc/puppet/puppet.conf
		</div>
	</li>
	<li>Puppet has files called manifest, which contains description about the system configuration.<br />
Create a default manifest.

		<div class="hacker">
		sudo touch /etc/puppet/manifests/site.pp
		</div>
	</li>
	<li>Start Puppet.
		<div class="hacker">
			sudo service apache2 start
		</div>
	</li>
</ol>
<h2>Install Puppet Agent  </h2>
<ol>
	<li>Perform below steps on all servers which you need, to connect to master puppet server.
Download the Puppet Labs package.
		<div class="hacker">
		wget https://apt.puppetlabs.com/puppetlabs-release-trusty.deb
		</div>
	</li>
	<li>Install the package.
		<div class="hacker">
			sudo dpkg -i puppetlabs-release-trusty.deb
		</div>
	</li>
	<li>Update repositories.
		<div class="hacker">
		sudo apt-get update
		</div>
	</li>
	<li>Install the Puppet agent package.
		<div class="hacker">
		sudo apt-get install puppet
		</div>
	</li>
	<li>Enable Puppet agent, which is disabled by default.
		<div class="hacker">
			sudo vi /etc/default/puppet
		</div>
	</li>
	<li>Change START value to yes.
		<div class="hacker">START=yes
		</div>
	</li>
	<li>Save and exit file.
		
	</li>
	<li>Lock the puppet version.
		<div class="hacker">sudo vi /etc/apt/preferences.d/00-puppet.pref
		</div>
	</li>
	<li>Add the below lines:
		<div class="hacker">
		# /etc/apt/preferences.d/00-puppet.pref<br />
Package: puppet puppet-common<br />
Pin: version 3.8*<br />
Pin-Priority: 501<br />

		</div>
	</li>
	<li>
		Save and exit the file.
	</li>
</ol>
<h2>Configure Agent </h2>
<ol>
	<li>Edit configuration file.
		<div class="hacker">sudo vi /etc/puppet/puppet.conf
		</div>
	</li>
	<li>Delete line with <code>templatedir</code>, and also delete the <code>[master]</code> section.
	</li>
	<li>Add below statement to the section:
		<div class="hacker">
		[agent]<br />
server = puppet.coolexample.com

		</div>
		This will specify which the puppet master is.
	</li>
	<li>
		Save and exit the file.
	</li>
	<li>Start the Puppet.
		<div class="hacker">sudo service puppet start
		</div>This will configure <strong>host1</strong> server with puppet. Like this you can edit all host servers to join puppet master server.
	</li>
</ol>
<h2>Sign request on Master</h2>
As soon as the puppet starts in agent node, it will send a certificate to master server. The master signs this certificate and then he will be able to manage the agent node. Below steps describe the full process.
<h3>List Certificates</h3>
<ul>
	<li>
		View the unsigned certificate in puppet master by running following command:
		<div class="hacker">
		sudo puppet cert list
		</div>
		If you have one agent node, then you will have one request. It contains the hostname of the agent node.
		<div class="hacker">
		"host1. coolexample.com" (SHA256) <br />B1:96:ED:1F:F7:1E:40:53:C1:D4:1B:3C:75:F4:7C:0B:A9:4C:1B:5D:95:2B:79:C0:08:DD:2B:F4:4A:36:EE:E3
		</div>
	</li>
</ul>
<h3>
Sign a request
</h3>
<ol>
	<li>
		Use puppet cert sign command to sign an agent nodes certificate in master server.
		<div class="hacker">
		sudo puppet cert sign host1.coolexample.com
		</div>
		View the below output:
		<div class="hacker">
		Notice: Removing file Puppet::SSL::CertificateRequest host1.coolexample.com at '/var/lib/puppet/ssl/ca/requests/host1.coolexample.com.pem'
		</div>
		At this point puppet master server can communicate and control agent nodes which are signed through certificates.
	</li>
	<li>
		Sign the entire request.
		<div class="hacker">
			sudo puppet cert sign --all
		</div>
	</li>
</ol>
<h3>Revoke certificate</h3>
<ul>
	<li>
		Remove or rebuild a host from puppet by revokinge the host certificate.
		<div class="hacker">
		sudo puppet cert clean <em><u>hostname</u></em>
		</div>
	</li>
	<li>
		View all signed certificate.
		<div class="hacker">
		sudo puppet cert list --all
		</div>
	</li>
</ul>
<h2>Getting Started with Puppet</h2>
All above steps are complete and you have your puppet master-agent infrastructure setup and running. Let's show you some basic tasks on puppet environment now.
<h3>How Facts Are Gathered</h3>
Puppet has a tool called <strong>Facter</strong>. Using this tool puppet gathers information about all agent nodes running in infrastructure. By default it gathers all system configuration information.
<ul>
	<li>View the list of factors.
	<div class="hacker">
		facter
	</div>
	</li>
</ul>
<h3>How Main Manifest Is Executed</h3>
Puppet agent is configured to periodically check with puppet master. During this time, puppet agent will send facts about itself to master and then it pulls a list of resources from master, which are determined by its main manifest.
<h3>Immediate Execution on a Particular Agent Node</h3>
<ul>
	<li>Run the below command on agent to check with master:
	<div class="hacker">
		sudo puppet agent --test
	</div>
	or
	<div class="hacker">
		sudo puppet agent -t
	</div>
	It will show below details:
	<div class="hacker">
		Info: Retrieving pluginfacts<br />
Info: Retrieving plugin<br />
Info: Loading facts in /var/lib/puppet/lib/facter/pe_version.rb<br />
Info: Loading facts in /var/lib/puppet/lib/facter/puppet_vardir.rb<br />
Info: Loading facts in /var/lib/puppet/lib/facter/root_home.rb<br />
Info: Loading facts in /var/lib/puppet/lib/facter/facter_dot_d.rb<br />
Info: Caching catalog for host1.coolexample.com<br />
Info: Applying configuration version '1407966507'<br />

	</div>
	Using this command, you can see the number of manifest which will affect a server or node immediately.
	</li>
</ul>
<h3>One-off Manifests</h3>
Using puppet apply command, you can execute a manifests which are not related to the main manifest. This is isolated to the node on which this command is executed. Eg.
<div class="hacker">
Eg: sudo puppet apply /etc/puppet/modules/test/init.pp
</div>
<h2>A Simple Manifest</h2>
File <code>/etc/puppet/manifests/site.pp</code> contains puppet master main manifests.
<ol>
	<li>Edit file.
	<div class="hacker">
	sudo vi /etc/puppet/manifests/site.pp
	</div>
	</li>
	<li>
	Add the following lines:
	<div class="hacker">
		<pre>
		file {'/tmp/example-ip':                                            
		  ensure  => present,
		  mode    => 0644,                                                  
		  content => "My Public IP Address is: ${ipaddress_eth0}.\n",  
		}

		</pre>
	</div>
	</li>
	<li>Save the file and exit. </li>
	<li>Execution of above line will create a file named <code>/tmp/example-ip</code> and this will contain the public IP address of the node.</li>
	<li>Either you can wait for the agent node to check this change through routine checkups or you can execute manually as:
		<div class="hacker">
			sudo puppet agent --test
		</div>
		or
		<div class="hacker">
			sudo puppet agent -t
		</div>
	</li>
</ol>
<h3>Specify a Node</h3>
If you want to define a specific node, then
<ol>
	<li>
		Edit file. <code>/etc/puppet/manifests/site.pp</code>
		<div class="hacker">
			sudo vi /etc/puppet/manifests/site.pp
		</div>
	</li>
	<li>
		Add the following lines:
		<div class="hacker">
			<pre>
				node 'ns1', 'ns2' {    
				  file {'/tmp/dns':    
					ensure => present, 
					mode => 0644,
					content => "Only DNS servers get this file.\n",
				  }
				}
				node default {}    
			</pre>
		</div>
	</li>
	<li>
		Save and exit the file.
	</li>
	<li>
		Execute command <code> sudo puppet agent -test </code>or wait for the agent pull from, for the file <code>/tmp/dns </code>will be created.
	</li>
</ol>
<h3>Using a Module</h3>
Modules are used to group tasks together. You can get different modules in puppet community. Here you will install <code>puppetlabs-apache </code>module from <code>forgeapi</code>.
<ol>
	<li>
		Execute following command.
		<div class="hacker">sudo puppet module install puppetlabs-apache
		</div>
	</li>
	<li>
		Edit file.
		<div class="hacker">
		sudo vi /etc/puppet/manifest/site.pp
		</div>
	</li>
	<li>Add the following lines:
		<div class="hacker">
			<pre>
				node 'host2' {
				  class { 'apache': }             
				  apache::vhost { 'coolexample.com':  
					port    => '80',
					docroot => '/var/www/html'
				  }
				}

			</pre>
		</div>
	</li>
	<li>
		Save and exit the file.
	</li>
	<li>
		Above code will make host2 to install Apache package and will make it listening on port 80. To execute manually execute command:
		<div class="hacker">
		sudo puppet agent --test
		</div>
		Or
		<div class="hacker">
		sudo puppet agent -t
		</div>
	</li>
</ol>

<h2>Conclusion</h2>
In this article, you have learnt how to install and configure puppet in an infrastructure.  Puppet makes Server Administrators tasks much easier.


</body>
</html>