<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:mso="urn:schemas-microsoft-com:office:office" xmlns:msdt="uuid:C2F41010-65B3-11d1-A29F-00AA00C14882">

<head>

<!--Article Number is __________ (fill in blank)-->

<!--Use this template for articles that explain or describe something (such as an operating system). For articles that include steps for accomplishing a task (for example, installing), use the Informational template instead.  -->


<title>Use Monkeysphere to authenticate SSH users - CentOS, Fedora</title>
<style type="text/css">
div.hacker {
background-color:#666;
border:1px solid #ccc;
color:#fff;
font-family:"Lucida Console","Courier New",Courier,fixed;  font-size:95%;  line-height:160%;  margin-bottom:1.5em;  padding:10px; }

p.note {
 background-color:#ffffe6;
 border:1px solid #eee;
 color:#666;
 padding:.8em 1.6em;
 margin:15px 0;
}

.warning {
 border: 1px #d25100 solid;
 padding: .5em 1em .5em 4em;
 margin: 10px 20px 15px 20px;
 background-image: url('@{help-img-path}/img_warning.gif');
 background-repeat: no-repeat;
 background-position: left top;
 background-color: #ededed;-moz-border-radius:
0.8em;-webkit-border-radius: 0.8em;
 /* -moz-border-bottom-radius: 0;9 */
 -webkit-border-bottom-radius: 0;
 padding-top:14px;
 padding-bottom:15px;
}
</style>


<!--[if gte mso 9]><xml>
<mso:CustomDocumentProperties>
<mso:ArticleKeywords msdt:dt="string">Security,</mso:ArticleKeywords>
<mso:Reference msdt:dt="string">https://www.digitalocean.com/community/tutorials/how-to-authenticate-users-to-a-ssh-server-using-monkeysphere-on-an-ubuntu-vps, https://www.digitalocean.com/community/tutorials/how-to-authenticate-users-to-a-ssh-server-using-monkeysphere-on-an-ubuntu-vps</mso:Reference>
<mso:LinuxDistributions msdt:dt="string">;#CentOS;#Fedora;#</mso:LinuxDistributions>
<mso:ArticlePriority msdt:dt="string">8</mso:ArticlePriority>
<mso:RequestNotes msdt:dt="string"></mso:RequestNotes>
<mso:Difficulty msdt:dt="string">3</mso:Difficulty>
<mso:ForkSplit msdt:dt="string"></mso:ForkSplit>
<mso:ArticleID msdt:dt="string">18805</mso:ArticleID>
<mso:UnsupportedFeatures msdt:dt="string"></mso:UnsupportedFeatures>
<mso:Collapsed msdt:dt="string"></mso:Collapsed>
<mso:Complexity msdt:dt="string"></mso:Complexity>
<mso:ArticleStatus msdt:dt="string">Not started</mso:ArticleStatus>


<mso:Sample msdt:dt="string">z</mso:Sample>
<mso:DeliveryTarget msdt:dt="string"></mso:DeliveryTarget>
<mso:EditScore msdt:dt="string"></mso:EditScore>
<mso:PrereqOrdering msdt:dt="string">2</mso:PrereqOrdering>
<mso:AssignedTo1 msdt:dt="string">12</mso:AssignedTo1>
<mso:display_urn_x003a_schemas-microsoft-com_x003a_office_x003a_office_x0023_AssignedTo1 msdt:dt="string">Tom Taylor</mso:display_urn_x003a_schemas-microsoft-com_x003a_office_x003a_office_x0023_AssignedTo1>
</mso:CustomDocumentProperties>
</xml><![endif]-->
</head>

<body>

    <h1>Use Monkeysphere to authenticate SSH users - CentOS, Fedora</h1>
    
    <p><strong>Difficulty</strong>: <em>3</em><br/>
        <strong>Time</strong>: <em>3 hour</em></p>

    <p>In this article, you will learn how to authenticate ssh users through Monkeysphere that will allow you to have a trusted SSH login.</p>

    <p>You should have an infrastructure in which Monkeysphere is installed and configured. If it is not done, then use below URL to complete the same.</p>
    
    <p><a href="#">Install and configure Monkeysphere - CentOS, Fedora</a></p>
 
   <h2>Create identity certifier on SSH server</h2>
   <p>Identity certifier is one that is trusted and ensures that users are trusted.  In this article, you will use admin server as the identity certifier.</p>
<ol> 
<li>Get the fingerprint of our administrative user.
   <div class="hacker">gpg --with-colons --fingerprint admin@junkdomain.com</div>
   <div class="hacker">
<pre>
tru::1:1441542079:0:3:1:5
pub:u:2048:1:DEA69AE3462908AF:2015-09-05:::u:admin &lt;admin@junkdomain.com&gt;::scESC:
fpr::::::::: <em><u>99981C07DC4177F646AFF531DEA69AE3462908A</u></em>
sub:u:2048:1:D5542FF062F4D3E5:2015-09-05::::::e:
</pre>
   </div>
   </li>
   <li>Add the fingerprint  in the SSH server.
   <div class="hacker">monkeysphere-authentication add-identity-certifier <em><u>99981C07DC4177F646AFF531DEA69AE3462908AF</u></em></div>
   <p>With this, Monkeysphere will get the GPG key from key server that will be added to its key ring.</p>
   </li>
   </ol>
   
   <h2>Generate subkeys for SSH users</h2>
   <p>Perform few steps on client server. Each client must generate a GPG sub key. This key will be used for user authentication purpose. Since you know that you already have a GPG key, this key will be used to identify the user.</p>
  
   <ol>
   <li>Use monkeysphere command to generate sub keys on client servers.
   <div class="hacker">monkeysphere gen-subkey</div>
   <p>This key generation process will take a long time. Once the sub key is generated, it is added to your local GPG key ring.</p>
   </li>
   <li>Upload the key change to the key server. For this, list the sub key in client key ring and then upload it to key server.
   <div class="hacker">gpg --list-keys client@junkdomain.com</div>
   <div class="hacker">gpg --keyserver pool.sks-keyservers.net --send-key <em><u>EDSGT0</u></em></div>
   <p>After uploading, the client sub key will be available in key server. This will take few minutes to complete the task.</p>
   </li>
  </ol>


<h2>Create authentication files on SSH server</h2>
<p>You will create the actual authentication file with below steps. These user level files are located in a sub directory, in each user’s home directory.</p>
<p>Monkeysphere uses these files to generate authentication files for SSH server. Monkeysphere generate authentication file in <code>/var/lib/monkeysphere/authorized_keys</code> location.</p>
<p>Create the files and directories in SSH server.</p>
<ol> 
<li>Create directory in user home directory.
   <div class="hacker">mkdir .monkeysphere</div>
   </li>
   <li>Grant specific permissions.
   <div class="hacker">chmod 755 .monkeysphere</div>
   <div class="hacker">cd .monkeysphere</div>
   </li>
   <li>Create a file named <code>authorized_user_ids</code> and add the client and admin keys. You can find those keys by giving <code>gpg --list-keys client@junkdomain.com </code>or <code>gpg --list-keys admin@junkdomain.com </code>command in respective droplets.
   <div class="hacker">
<pre>
vi  authorized_user_ids
client &lt;client@junkdomain.com&gt;
admin &lt;admin@junkdomain.com&gt;
</pre>
   </div>
   </li>
   <li>Give proper permission for file.
   <div class="hacker">chmod 644 authorized_user_ids</div>
   <p>You need to repeat this step for all users.</p>
   </li>
   <li>Create internal authentication files.
   <p>Execute below command to create authentication file. This command should be run after making any changes to user authentication.</p>
   <div class="hacker">monkeysphere-authentication update-users</div>
   <p>If you want to update any particular user, then use the following command:</p>
   <div class="hacker">monkeysphere-authentication update-users <em><u>user_name</u></em></div>
   </li>
   <li>Navigate to <code>/var/lib/monkeysphere/authorized_keys </code>directory and you will see the generated authentication file.
   <div class="hacker">
<pre>
cd /var/lib/monkeysphere/authorized_keys
ls
user
</pre>
</div>
</li>
<li>Open the file and view the key as normal <code>authorized_keys </code>entries.
   <div class="hacker">
<pre>
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC9R9BtcAFfd+qsGoaSqpDstif5UgM+CqVp46eNrfBsfXR9wT5vs1uPmdAiulM7GwB9Pl2J6IEobpceF516wv72OuUuH+Bg1Y8TIm6YI4MKALuCeBSP6uIT1uyN/Cdcnfk3LADphIBq8Un5xvB5taG8iVFnvYQ/E/wObJ7SLTGPsPzB2X7BEqFwAek6/VN8pzMr7djbEAOdoyD/GJ7iyZbWy2eLH65yl/2WiJa4cC6U/sfZlOLvp7XQX0oRV6iMJLOMCEWFOqekTHVsmOdszqHIRqe0n0zs8ZQtxkq7ODpNkn5XEG6Dq1Xz5Eqy06lNrjRM7UbxmKV7niFAJTQ7OcCX MonkeySphere2015-09-07T09:49:32 client client@junkdomain.com
</pre>
</div>
   </li>
   <li>Specify the authorized key location in <code>ssh</code> configuration.
   <div class="hacker">sudo vi /etc/ssh/sshd_config</div>
   <p>Search for AuthorizedKeysFile parameter and change it like,</p>
   <div class="hacker">AuthorizedKeysFile /var/lib/monkeysphere/authorized_keys/%u</div>
   <p>Save and close the file.</p>
   </li>
   <li>Restart ssh service
   <div class="hacker">service ssh restart</div>
   </li>

  </ol>


<h2>Configure client to send GPG key</h2>
<ol> 
<li>At this point the server is ready for authentication using GPG keys. Now you need to configure client to connect using GPG key rather than using a password.
<p>Execute below command from client.</p>
   <div class="hacker">ssh-agent sh -c 'monkeysphere subkey-to-ssh-agent &amp;&amp; ssh server.example.com'</div>
   </li>
   <li>You will only be asked to enter the key pass phrase and no user password will be prompted. After entering the key pass phrase, you will be logged in to server droplet.
   <p>You can also do this through an agent session.</p>
   <div class="hacker">eval $(ssh-agent) </div>
   <p>Edit ~/.bash_profile file to start the session automatically .</p>
   <div class="hacker">echo 'eval $(ssh-agent)' >> ~/.bash_profile</div>
   </li>
   <li>Add the GPG subkey to the client by executing the following command:
   <div class="hacker">monkeysphere subkey-to-ssh-agent</div>
   </li>
   <li>Provide the password upon prompt. This will save password for the entire session. 
   <div class="hacker">ssh-add –l</div>
   <p>Log in and you won’t be prompted for a pass phrase.</p>
   </li>
  </ol>
  
    <h2>Conclusion</h2>
    <p>In this article, you learnt to authenticate user through Monkeysphere. With this, clients do not need to worry about the authenticity of the server to which it is connecting to. </p>
   
</body>
</html>