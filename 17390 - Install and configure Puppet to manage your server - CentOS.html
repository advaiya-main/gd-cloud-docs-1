<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:mso="urn:schemas-microsoft-com:office:office" xmlns:msdt="uuid:C2F41010-65B3-11d1-A29F-00AA00C14882">

<head>

<!--Article Number is __________ (fill in blank)-->

<!--Use this template for articles that explain or describe something (such as an operating system). For articles that include steps for accomplishing a task (for example, installing), use the Informational template instead.  -->


<title>17390 - Install and configure Puppet to manage your server - CentOS</title>
<style type="text/css">
div.hacker {
background-color:#666;
border:1px solid #ccc;
color:#fff;
font-family:"Lucida Console","Courier New",Courier,fixed;  font-size:95%;  line-height:160%;  margin-bottom:1.5em;  padding:10px; }

p.note {
 background-color:#ffffe6;
 border:1px solid #eee;
 color:#666;
 padding:.8em 1.6em;
 margin:15px 0;
}

.warning {
 border: 1px #d25100 solid;
 padding: .5em 1em .5em 4em;
 margin: 10px 20px 15px 20px;
 background-image: url('@{help-img-path}/img_warning.gif');
 background-repeat: no-repeat;
 background-position: left top;
 background-color: #ededed;-moz-border-radius:
0.8em;-webkit-border-radius: 0.8em;
 /* -moz-border-bottom-radius: 0;9 */
 -webkit-border-bottom-radius: 0;
 padding-top:14px;
 padding-bottom:15px;
}
</style>


<!--[if gte mso 9]><xml>
<mso:CustomDocumentProperties>
<mso:ArticleKeywords msdt:dt="string">Puppet, Automation</mso:ArticleKeywords>
<mso:Reference msdt:dt="string">https://www.digitalocean.com/community/tutorials/how-to-install-puppet-to-manage-your-server-infrastructure, https://www.digitalocean.com/community/tutorials/how-to-install-puppet-to-manage-your-server-infrastructure</mso:Reference>
<mso:LinuxDistributions msdt:dt="string">;#CentOS;#</mso:LinuxDistributions>
<mso:ArticlePriority msdt:dt="string">1</mso:ArticlePriority>
<mso:RequestNotes msdt:dt="string">Configure puppet to automate server configuration across multiple machines. Master sheet is ubuntu, but make different install/config instructions for each distro. Will need link to Configure bind as private network dns server, and UFW tutorial.</mso:RequestNotes>
<mso:Difficulty msdt:dt="string">4</mso:Difficulty>
<mso:ForkSplit msdt:dt="string"></mso:ForkSplit>
<mso:ArticleID msdt:dt="string">17390</mso:ArticleID>
<mso:UnsupportedFeatures msdt:dt="string">Private Networking</mso:UnsupportedFeatures>
<mso:Collapsed msdt:dt="string"></mso:Collapsed>
<mso:Complexity msdt:dt="string"></mso:Complexity>
<mso:Week msdt:dt="string">2.00000000000000</mso:Week>
<mso:ArticleStatus msdt:dt="string">Not started</mso:ArticleStatus>

<mso:HoursDraftingEstimated msdt:dt="string">3.50000000000000</mso:HoursDraftingEstimated>
<mso:HoursEditingEstimated msdt:dt="string">0.500000000000000</mso:HoursEditingEstimated>
<mso:Sample msdt:dt="string">z</mso:Sample>
<mso:display_urn_x003a_schemas-microsoft-com_x003a_office_x003a_office_x0023_AssignedTo1 msdt:dt="string">Thomas Hallstrom</mso:display_urn_x003a_schemas-microsoft-com_x003a_office_x003a_office_x0023_AssignedTo1>
<mso:DeliveryTarget msdt:dt="string"></mso:DeliveryTarget>
<mso:EditScore msdt:dt="string"></mso:EditScore>
<mso:PrereqOrdering msdt:dt="string">4</mso:PrereqOrdering>
</mso:CustomDocumentProperties>
</xml><![endif]-->
</head>

<body>
<h1>Install and Configure Puppet to Manage Your Server - CentOS</h1>

<p><strong>Difficulty:</strong> <em>4</em></p>
<p><strong>Time:</strong> <em>30 minutes</em></p>

<h2>Introduction</h2>
<p>Puppet is a configuration management system that helps to automate configuration and management of server infrastructure.</p>
<p>Puppets are of two types:</p>
<ul>
<li>Puppet Enterprise</li>
<li>Open source Puppet</li>
</ul>

<p>In this article, you will learn to install open source puppet in a Master-Agent server setup. This includes a Puppet Master server which has all the configuration files and Puppet Agent server which will be querying for Master server for updates.</p>

<h2>Prerequisites</h2>
<p>You must have root access to follow this article. Before starting installation, you should have below infrastructure ready:</p>
<ul>
<li>Server with CentOS 7 installed. This will act as the Master server.</li>
<li>A private network DNS. If Private DNS is not configured on your infrastructure, then you can follow below link to set up one:
<p><a href="#">Install and Configure Private DNS</a></p>
</li>
<li>Firewall ports: You should check and confirm that port 8140 is accessible. You can use below link to understand about UFW to allow access to an incoming request.
<p><a href="#">Understanding UFW</a></p>
Throughout this article, the  below naming conventions will be used:
</li>
<li>For puppet master server hostname will be <strong>puppet</strong> and corresponding FQDN will be <strong>puppet.example.com</strong></li>
<li>For host nodes, it is <strong>host1</strong> and <strong>host2</strong> and its FQDN <strong>host1.example.com</strong> and <strong>host2.example.com</strong></li>
</ul>


<h2>Install NTP </h2>

<p>If time is not properly adjusted, then it can cause errors when puppet master issues agents certificates.</p>
<ol>
<li>Install NTP daemon so that time will be automatically updated.
<div class="hacker">sudo yum install ntp </div>
</li>
<li>Edit ntp.conf file.
<div class="hacker">sudo vi /etc/ntp.conf</div>
</li>
<li>Add time servers from NTP Pool Project page.
<div class="hacker"><xmp>server 0.centos.pool.ntp.org iburst
server 1.centos.pool.ntp.org iburst
server 2.centos.pool.ntp.org iburst
server 3.centos.pool.ntp.org iburst</xmp></div>
</li>

<li>Start NTP service.
<div class="hacker">sudo systemctl enable ntpd</div>
<div class="hacker">sudo systemctl start ntpd</div>
</li>

<li><p>Server will be having accurate time now.</p></li>

<li>Check and make sure that server is listening properly.
<div class="hacker">ntpq -p</div>
</li>
</ol>

<h2>Install Puppet Master </h2>
<ol>
<li>Get the correct version of yum repository.
<div class="hacker">sudo rpm -ivh https://yum.puppetlabs.com/puppetlabs-release-el-7.noarch.rpm</div>
</li>

<li>Install package.
<div class="hacker">sudo yum install puppet-server</div>
</li>
<li><p>Do not start the puppet service now.</p></li>
</ol>

<h2>Lock Puppet Version </h2>
<p>If the puppet server is updated or changed to another version, then it will stop working. For gaining consistency in this case, you need to maintain a single version in the server. In a puppet infrastructure, if agents have higher version number, then master won't be able to manage the same.  For this reason you need to lock the current version.</p>

<ol>
<li>View the current version.
<div class="hacker">puppet help | tail -n 1</div>
</li>

<li>Install package named <code>yum-version lock to lock the version of puppet</code>. Follow the below steps to achieve the same:
<div class="hacker">sudo yum install yum-versionlock</div>
</li>

<li>Lock puppet version.
<div class="hacker">sudo yum versionlock puppet</div>
<div class="hacker">sudo yum versionlock puppet-server</div>
</li>

<li><p>Your puppet version is locked now.</p></li>
</ol>
	
<h2>Names and Certificates</h2>
<p>Communication between puppet master and agent is being authenticated through SSL Certificates. Follow the below steps to generate master SSL certificate.</p>
<ol>
<li>Delete existing certificates from <code>/var/lib/puppet/ssl</code>
<div class="hacker">sudo rm -rf /var/lib/puppet/ssl</div>
</li>
<li>Edit <code>/etc/puppet/puppet.conf</code> file, in order to configure certificate.
<div class="hacker">sudo vi /etc/puppet/puppet.conf</div>
</li>

<li>It will look like:
<div class="hacker"><xmp>[main]
    logdir = /var/log/puppet
    rundir = /var/run/puppet
    ssldir = $vardir/ssl

[agent]
    classfile = $vardir/classes.txt
    localconfig = $vardir/localconfig</xmp></div>
</li>

<li>Add the below lines in this file:
<div class="hacker"><xmp>[master]
certname = puppet
dns_alt_names = puppet,puppet.example.com</xmp></div>
</li>

<li>Generate new Certificate.
<div class="hacker">sudo puppet master --verbose --no-daemonize</div>
</li>

<li><p>This will generate new certificate for puppet master. After running this command, you will see this line, <code>Notice: Starting Puppet master version 3.8.2</code>. This means that execution is completed. Press <code>Ctrl + c</code> to end the process.</p></li>
</ol>

<h2>Configure Puppet Master </h2>
<ol>
<li>Edit configuration file <code>/etc/puppet/puppet.conf</code> for configuring Puppet. 
<div class="hacker">sudo vi /etc/puppet/puppet.conf</div>
</li>
<li><p>Puppet has files called manifest, which contains description about the system configuration.</p></li>

<li>Create a default manifest.
<div class="hacker">sudo touch /etc/puppet/manifests/site.pp</div>
</li>
</ol>

<h2>Configure Webserver for the Puppet Master </h2>
<ol>
<li>Install necessary packages and its dependencies.
<div class="hacker">sudo yum install httpd httpd-devel mod_ssl ruby-devel rubygems gcc gcc-c++ curl-devel openssl-devel zlib-devel</div>
</li>

<li>Get necessary gems.
<div class="hacker">sudo gem install rack passenger</div>
</li>

<li>Create a swap file if your server doesn't have a swap partition.
<div class="hacker">sudo dd if=/dev/zero of=/swap bs=1M count=1024</div>
<div class="hacker">sudo mkswap /swap</div>
<div class="hacker">chmod 0600 /swap</div>
<div class="hacker">sudo swapon /swap</div>
</li>

<li>Get the apache-passenger module.
<div class="hacker">sudo /usr/local/bin/passenger-install-apache2-module</div>

<div class="hacker"><xmp>$ sudo /usr/local/bin/passenger-install-apache2-module
Welcome to the Phusion Passenger Apache 2 module installer, v4.0.48.
This installer will guide you through the entire installation process. It
shouldn't take more than 3 minutes in total.
Here's what you can expect from the installation process:
 1. The Apache 2 module will be installed for you.
 2. You'll learn how to configure Apache.
 3. You'll learn how to deploy a Ruby on Rails application.
Don't worry if anything goes wrong. This installer will advise you on how to
solve any problems.
Press Enter to continue, or Ctrl-C to abort.</xmp></div>
</li>

<li><p>Press Enter and continue.</p></li>

<li>You will get below screen. Choose Ruby and continue installation:
<div class="hacker"><xmp>Which languages are you interested in?
Use <space> to select.
If the menu doesn't display correctly, press '!'
-> Ruby
   Python
   Node.js</xmp></div>
</li>
   
<li>When the installation is successful, it will give below message:
<div class="hacker"><xmp>LoadModule passenger_module /usr/local/share/gems/gems/passenger-5.0.16/buildout/apache2/mod_passenger.so
   <IfModule mod_passenger.c>
     PassengerRoot /usr/local/share/gems/gems/passenger-5.0.16
     PassengerDefaultRuby /usr/bin/ruby
</IfModule></xmp></div>
</li>

<li>Move puppet master application into a generic location.
<div class="hacker">sudo mkdir -p /usr/share/puppet/rack/puppetmasterd</div>
<div class="hacker">sudo mkdir /usr/share/puppet/rack/puppetmasterd/public /usr/share/puppet/rack/puppetmasterd/tmp</div>
<div class="hacker">sudo cp /usr/share/puppet/ext/rack/config.ru /usr/share/puppet/rack/puppetmasterd/</div>
<div class="hacker">sudo chown puppet:puppet /usr/share/puppet/rack/puppetmasterd/config.ru</div>
</li>

<li>Configure apache to use the passenger module.
<div class="hacker">sudo cp /usr/share/puppet/ext/rack/example-passenger-vhost.conf /etc/httpd/conf.d/puppetmaster.conf</div>
</li>

<li>Modify file like this:
<div class="hacker"><xmp>sudo cat /etc/httpd/conf.d/puppetmaster.conf
LoadModule passenger_module /usr/local/share/gems/gems/passenger-5.0.16/buildout/apache2/mod_passenger.so
PassengerRoot /usr/local/share/gems/gems/passenger-5.0.16
PassengerDefaultRuby /usr/bin/ruby
# you probably want to tune these settings
PassengerHighPerformance on
PassengerMaxPoolSize 12
PassengerPoolIdleTime 1500
# PassengerMaxRequests 1000
PassengerStatThrottleRate 120
#RackAutoDetect Off
#RailsAutoDetect Off
ServerName puppet.example.com
Listen 8140
<VirtualHost *:8140>
        SSLEngine on
        SSLProtocol             ALL -SSLv2 -SSLv3
        SSLCipherSuite          EDH+CAMELLIA:EDH+aRSA:EECDH+aRSA+AESGCM:EECDH+aRSA+SHA384:EECDH+aRSA+SHA256:EECDH:+CAMELLIA256:+AES256:+CAMELLIA128:+AES128:+SSLv3:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!PSK:!DSS:!RC4:!SEED:!IDEA:!ECDSA:kEDH:CAMELLIA256-SHA:AES256-SHA:CAMELLIA128-SHA:AES128-SHA
        SSLHonorCipherOrder     on
        SSLCertificateFile      /var/lib/puppet/ssl/certs/puppet.pem
        SSLCertificateKeyFile   /var/lib/puppet/ssl/private_keys/puppet.pem
        SSLCertificateChainFile /var/lib/puppet/ssl/ca/ca_crt.pem
        SSLCACertificateFile    /var/lib/puppet/ssl/ca/ca_crt.pem
        # If Apache complains about invalid signatures on the CRL, you can try disabling
        # CRL checking by commenting the next line, but this is not recommended.
        SSLCARevocationFile     /var/lib/puppet/ssl/ca/ca_crl.pem
        # Apache 2.4 introduces the SSLCARevocationCheck directive and sets it to none
        # which effectively disables CRL checking; if you are using Apache 2.4+ you must
        # specify 'SSLCARevocationCheck chain' to actually use the CRL.
        # SSLCARevocationCheck chain
        SSLVerifyClient optional
        SSLVerifyDepth  1
        # The `ExportCertData` option is needed for agent certificate expiration warnings
        SSLOptions +StdEnvVars +ExportCertData
        # This header needs to be set if using a loadbalancer or proxy
        RequestHeader unset X-Forwarded-For
        RequestHeader set X-SSL-Subject %{SSL_CLIENT_S_DN}e
        RequestHeader set X-Client-DN %{SSL_CLIENT_S_DN}e
        RequestHeader set X-Client-Verify %{SSL_CLIENT_VERIFY}e
        DocumentRoot /usr/share/puppet/rack/puppetmasterd/public
        RackBaseURI /
        <Directory /usr/share/puppet/rack/puppetmasterd/>
                Options None
                AllowOverride None
                Order allow,deny
                allow from all
        </Directory>
</VirtualHost></xmp></div>
</li>

<li>Make sure the configuration is correct.
<div class="hacker">sudo apachectl -t</div>
<div class="hacker">Syntax OK</div>
</li>

<li>Disable Puppet Master if it is enabled.
<div class="hacker"><xmp>systemctl list-unit-files | grep puppet
puppet.service                         disabled
puppetagent.service                    disabled
puppetmaster.service                   disabled</xmp></div>
</li>

<li>Start <code>httpd</code> service:
<div class="hacker">sudo systemctl enable httpd.service</div>
<div class="hacker">sudo systemctl start httpd.service</div>
</li>
</ol>

<h2>Install Puppet Agent </h2>

<p>Configure DNS properly and make sure that puppet master and agent resolve properly. Follow the same procedure in all agents.</p>
<ol>
<li>Install <strong>PuppetLab</strong> yum repository.
<div class="hacker">sudo rpm -ivh http://yum.puppetlabs.com/puppetlabs-release-el-7.noarch.rpm</div>
</li>
<li>Install the Puppet agent package.
<div class="hacker">sudo yum install puppet</div>
</li>
</ol>

<h2>Lock puppet version</h2>
<ol>
<li>View the current version.
<div class="hacker">puppet help | tail -n 1</div>
</li>
<li>Install package named yum-version lock to lock the version of puppet. Follow below steps to achieve the same:
<div class="hacker">sudo yum install yum-versionlock</div>
</li>
<li>Lock puppet version:
<div class="hacker">sudo yum versionlock puppet</div>
</li>
<li><p>Your puppet version is locked now.</p></li>
</ol>

<h2>Configure Agent </h2>
<ol>
<li>Edit configuration file.
<div class="hacker">sudo vi /etc/puppet/puppet.conf</div>
</li>

<li>Add below statement to the section:
<div class="hacker"><xmp>[agent]
server = puppet.example.com</xmp></div>
</li>

<li><p>This will specify which the puppet master is.</p></li>

<li><p>Save and exit the file.</p></li>

<li>Start the agent.
<div class="hacker">systemctl list-unit-files | grep puppet</div>

<div class="hacker">sudo puppet resource service puppet ensure=running enable=true</div>

<div class="hacker"><xmp>systemctl list-unit-files | grep puppet
puppet.service                         enabled 
puppetagent.service                    disabled</xmp></div>
</li>

<li><p>This will configure host1 server with puppet. Like this you can edit all host servers to join puppet master server.</p></li>
</ol>
 
<h2>Sign request on Master </h2>

<p>As soon as the puppet starts in agent node, it will send a certificate to master server. The master signs this certificate and then he will be able to manage the agent node. Below steps describe the full process:</p>

<h3>List Certificates</h3>
<ol>
<li>View the unsigned certificate in puppet master by running following command:
<div class="hacker">sudo puppet cert list</div>
</li>
<li>If you have one agent node, then you will have one request. It contains the hostname of the agent node.
<div class="hacker">"host1. example.com" (SHA256) B1:96:ED:1F:F7:1E:40:53:C1:D4:1B:3C:75:F4:7C:0B:A9:4C:1B:5D:95:2B:79:C0:08:DD:2B:F4:4A:36:EE:E3</div>
</li>
</ol>

<h3>Sign a request</h3>
<ol>
<li>Use puppet cert sign command to sign an agent nodes certificate in master server.
<div class="hacker">sudo puppet cert sign host1.example.com</div>
</li>

<li>The output is as below:
<div class="hacker"><xmp>Notice: Signed certificate request for host1.example.com
Notice: Removing file Puppet::SSL::CertificateRequest host1.example.com at '/var/lib/puppet/ssl/ca/requests/host1.example.com.pem'</xmp></div>
</li>

<li><p>At this point puppet master server can communicate and control agent nodes which are signed through certificates.</p></li>

<li>Sign the entire request.
<div class="hacker">sudo puppet cert sign --all</div>
</li>
</ol>

<h3>Revoke certificate</h3>
<ol>
<li>Remove or rebuild a host from puppet. Then you need to revoke host certificate.
<div class="hacker">sudo puppet cert clean hostname</div>
</li>
<li>View all signed certificate.
<div class="hacker">sudo puppet cert list --all</div>
</li>
</ol>

<h2>Getting Started with Puppet </h2>
<p>All above steps are complete and you have your puppet master-agent infrastructure setup and running. Let's show you some basic tasks on puppet environment now.</p>

<h3>How Facts Are Gathered </h3>
<p>Puppet has a tool called Facter. Using this tool puppet gathers information about all agent nodes running in infrastructure. By default it gathers all system configuration information.</p>
<p>View the list of factors.</p>
<div class="hacker">facter</div>

<h3>How Main Manifest Is Executed</h3>
<p>Puppet agent is configured to periodically check with puppet master. During this time, puppet agent will send facts about itself to master and then it pulls a list of resources from master, which are determined by its main manifest.</p>

<h3>Immediate Execution on a Particular Agent Node.</h3>
<ol>
<li>Run the below command on agent to check with master: 
<div class="hacker">sudo puppet agent -t  </div>
<p>or</p>
<div class="hacker">sudo puppet agent --test</div>
</li>

<li>It will show below details:
<div class="hacker"><xmp>Info: Retrieving pluginfacts
Info: Retrieving plugin
Info: Loading facts in /var/lib/puppet/lib/facter/pe_version.rb
Info: Loading facts in /var/lib/puppet/lib/facter/puppet_vardir.rb
Info: Loading facts in /var/lib/puppet/lib/facter/root_home.rb
Info: Loading facts in /var/lib/puppet/lib/facter/facter_dot_d.rb
Info: Caching catalog for host1.example.com
Info: Applying configuration version '1407966507'</xmp></div>
</li>

<li><p>Using this command, you can see the number of manifest which will affect a server or node immediately.</p></li>
</ol>

<h3>One-off Manifests</h3>
<p>Using puppet apply command, you can execute a manifests which are not related to the main manifest. This is isolated to the node on which this command is executed.</p>
<div class="hacker">Eg: sudo puppet apply /etc/puppet/modules/test/init.pp</div>

<h2>A Simple Manifest </h2>
<ol>
<li><p>File <code>/etc/puppet/manifests/site.pp</code> contains puppet master main manifests.</p></li>
<li>Edit file.
<div class="hacker">sudo vi /etc/puppet/manifests/site.pp.</div>
</li>
<li>Add the following lines:
<div class="hacker"><xmp>File {'/tmp/example-ip':                                
  ensure  => present,
  mode    => 0644,                                                 
  content => "My Public IP Address is: ${ipaddress_eth0}.\n",  
}</xmp></div>
</li>

<li><p>Save the file and exit. </p></li>

<li><p>Execution of above line will create a file named /tmp/example-ip and this will contain the public IP address of the node.</p></li>

<li>Either you can wait for the agent node to check this change through routine checkups or you can execute manually as:
<div class="hacker">sudo puppet agent -t</div>
<p>Or</p>
<div class="hacker">sudo puppet agent --test</div>
</li>
</ol>

<h3>Specify a Node</h3>

<p>If you want to define a specific node, then</p>
<ol>
<li>Edit file <code>/etc/puppet/manifests/site.pp</code>
<div class="hacker">sudo vi /etc/puppet/manifests/site.pp</div>
</li>

<li>Add the following lines:
<div class="hacker"><xmp>node 'ns1', 'ns2' {    
  file {'/tmp/dns':    
    ensure => present, 
    mode => 0644,
    content => "Only DNS servers get this file.\n",
  }
}
node default {} </xmp></div>   
</li>
<li><p>Save and exit the file.</p></li>
<li><p>Execute command <code>sudo puppet agent -test</code> or wait for the agent pull from, the file <code>/tmp/dns</code> will be created.</p></li>
</ol>

<h3>Using a Module</h3>
<ol>
<li>Modules are used to group tasks together. You can get different modules in puppet community. Here you will install <code>puppetlabs-apache</code> module from <code>forgeapi</code>.
<div class="hacker">sudo puppet module install puppetlabs-apache</div>
</li>
<li>Edit file.
<div class="hacker">sudo vi /etc/puppet/manifest/site.pp</div>
</li>
<li>Add the following lines:
<div class="hacker"><xmp>node 'host2' {
  class { 'apache': }             
  apache::vhost { 'example.com':  
    port    => '80',
    docroot => '/var/www/html'
  }
}</xmp></div>
</li>
<li><p>Save and exit the file.</p></li>
<li>Above code will make host2 to install Apache package and will make it listening on port 80. To execute manually execute command:
<div class="hacker">sudo puppet agent -t</div>
<p>or</p>
<div class="hacker">sudo puppet agent --test</div>
</li>
</ol>

<h2>Conclusion</h2>
<p>In this article, you have learnt to install and configure puppet in an infrastructure.  Puppet makes Server Administrators tasks much easier.</p>

</body>
</html>